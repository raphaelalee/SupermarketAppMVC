<%- include('partials/header') %>

<section class="shopping-wrapper container">
  <aside class="filter-card">
    <div class="filter-header">
      <p class="text-muted small mb-1">Browse by</p>
      <h5>Categories</h5>
    </div>
    <ul class="category-list">
      <% (categories || []).forEach((cat) => {
           const catName = cat && cat.category ? cat.category : cat;
           if (!catName) return;
      %>
        <li>
          <a href="/shopping?category=<%= encodeURIComponent(catName) %>" class="<%= category === catName ? 'active' : '' %>">
            <span><%= catName %></span>
            <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      <% }) %>
    </ul>
  </aside>

  <div class="products-panel">
    <div class="products-topbar">
      <div>
        <p class="text-muted small mb-1">
          <a href="/" class="text-decoration-none text-success">Home</a>
          <span class="mx-2">></span>
          <span><%= displayCategory %></span>
        </p>
        <h2><%= displayCategory %></h2>
      </div>
      <form class="d-flex align-items-center gap-2" action="/shopping" method="get">
        <input
          type="text"
          class="form-control"
          name="search"
          placeholder="Search products or categories..."
          value="<%= search %>">
        <select name="category" class="form-select">
          <option value="">All Items</option>
          <% (categories || []).forEach((c) => { 
               const catName = c && c.category ? c.category : c;
               if (!catName) return;
          %>
            <option value="<%= catName %>" <%= category === catName ? 'selected' : '' %>>
              <%= catName %>
            </option>
          <% }) %>
        </select>
        <button class="btn btn-success" type="submit">Search</button>
        <% if (search) { %>
          <a href="/shopping" class="btn btn-outline-secondary">Clear</a>
        <% } %>
      </form>
    </div>

    <% if (products && products.length > 0) { %>
      <div class="products-grid">
        <% products.forEach((product) => { %>
          <article class="shopping-card">
            <div class="card-image" style="background-image:url('/images/<%= product.image %>');"></div>
            <div class="card-body">
              <p class="product-category"><%= product.category %></p>
              <h5><%= product.productName %></h5>
              <p class="product-price">$<%= product.price.toFixed(2) %></p>
              <% if (Number(product.quantity || 0) <= 0) { %>
                <div class="mb-2"><span class="badge bg-danger">Out of stock</span></div>
                <button class="btn btn-secondary w-100" disabled>Out of stock</button>
              <% } else { %>
                <form action="/add-to-cart/<%= product.id %>" method="POST">
                  <input type="hidden" name="quantity" value="1">
                  <button class="btn btn-outline-success w-100">Add to Cart</button>
                </form>
              <% } %>
            </div>
          </article>
        <% }) %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <h4>Nothing to show yet</h4>
        <p>We couldn't find any products that match those categories. Try another search or browse all products.</p>
        <a href="/shopping" class="btn btn-success">View All Products</a>
      </div>
    <% } %>
  </div>
</section>

<%- include('partials/footer') %>
