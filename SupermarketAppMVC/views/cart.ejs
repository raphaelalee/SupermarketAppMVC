<%- include('partials/header') %>

<section class="cart-page-wrap">
  <div class="container cart-page-grid">
    <div class="cart-col">
      <div class="cart-header-row">
        <div>
          <p class="text-muted small mb-1">FreshMart</p>
          <h2>Your basket</h2>
        </div>
        <a href="/shopping" class="btn btn-outline-success btn-pill-sm">Continue Shopping</a>
      </div>

      <% const hasItems = items.length > 0; %>
      <% if (!hasItems) { %>
        <div class="cart-empty-state">
          <h4>Your cart is empty</h4>
          <p class="text-muted mb-3">Browse our curated catalogue to add groceries, then revisit this page to checkout.</p>
          <a class="btn btn-success" href="/shopping">Discover Products</a>
        </div>
      <% } else { %>
        <div class="cart-item-list">
          <% items.forEach(item => { %>
            <article class="cart-line align-items-center">
              <label class="form-check me-3 mb-0">
                <input
                  class="form-check-input"
                  type="checkbox"
                  data-select-checkbox
                  data-item-id="<%= item.id %>"
                  data-item-qty="<%= item.quantity %>"
                  <%= item.selected ? 'checked' : '' %>
                >
              </label>
              <div class="line-media">
                <img src="/images/<%= item.image || 'broccoli.png' %>" alt="<%= item.productName %>" style="width:120px;height:120px;object-fit:contain;">
              </div>
              <div class="line-body">
                <div class="line-info">
                  <div>
                    <h5><%= item.productName %></h5>
                    <p class="text-muted small mb-1">Category: <%= item.category || 'Groceries' %></p>
                  </div>
                  <strong>$<%= Number(item.subtotal).toFixed(2) %></strong>
                </div>
                <div class="line-actions">
                  <form action="/cart/update/<%= item.id %>" method="POST" class="qty-form">
                    <button type="submit" name="quantity" value="<%= Math.max(0, item.quantity - 1) %>">-</button>
                    <span><%= item.quantity %></span>
                    <button type="submit" name="quantity" value="<%= item.quantity + 1 %>">+</button>
                  </form>
                  <form action="/cart/remove/<%= item.id %>" method="POST">
                    <button class="btn btn-link text-danger">Remove</button>
                  </form>
                </div>
              </div>
            </article>
          <% }) %>
        </div>
      <% } %>
    </div>

    <aside class="summary-col">
      <div class="summary-card">
        <h4>Order Summary</h4>
        <p class="text-muted small mb-3">Quick snapshot of your costs before checkout.</p>
        <div class="summary-row">
          <span>Subtotal (selected)</span>
          <strong>$<%= Number(selectedTotal || 0).toFixed(2) %></strong>
        </div>
        <div class="summary-row">
          <span>Estimated Delivery</span>
          <strong>$3.50*</strong>
        </div>
        <div class="summary-row">
          <span>Rewards Savings</span>
          <strong class="text-success">$0.00</strong>
        </div>
        <p class="text-muted small mb-3">*Exact delivery fee calculated during checkout when you choose a method.</p>
        <% const isLoggedIn = !!user; const hasSelected = Number(selectedTotal || 0) > 0; %>
        <form action="<%= isLoggedIn ? '/checkout' : '/login' %>" method="get">
          <button class="btn btn-success w-100" <%= hasSelected ? '' : 'disabled' %>><%= isLoggedIn ? 'Proceed to Checkout' : 'Log in to Checkout' %></button>
        </form>
        <% if (!isLoggedIn) { %>
          <a href="/register" class="btn btn-outline-success w-100 mt-2">Create an Account</a>
          <p class="text-muted small mt-2 mb-0">Please log in or sign up before completing your purchase.</p>
        <% } %>
        <% if (hasItems) { %>
          <form action="/cart/clear" method="POST" class="mt-3">
            <button class="btn btn-link text-danger w-100">Clear Cart</button>
          </form>
        <% } %>
      </div>

      <div class="summary-card">
        <h5>Need help?</h5>
        <p class="text-muted small mb-2">Our concierge team can assist with substitutions, delivery tweaks, and more.</p>
        <ul class="text-muted small ps-3 mb-0">
          <li>WhatsApp us at +65 6123 4567</li>
          <li>Email hello@freshmart.sg</li>
          <li>Live chat available 8 AM â€“ 10 PM</li>
        </ul>
      </div>
    </aside>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-select-checkbox]').forEach((checkbox) => {
      checkbox.addEventListener('change', () => {
        const id = checkbox.getAttribute('data-item-id');
        const qty = checkbox.getAttribute('data-item-qty') || 1;
        const params = new URLSearchParams();
        params.append('quantity', qty);
        params.append('selected', checkbox.checked);

        fetch(`/cart/update/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString(),
        }).then(() => window.location.reload());
      });
    });
  });
</script>

<%- include('partials/footer') %>
