<%- include("partials/header") %>

<% const totalProducts = products.length; %>
<% const uniqueCategories = [...new Set(products.map(p => p.category))]; %>
<% const totalValue = products.reduce((sum, p) => sum + Number(p.price || 0), 0); %>

<section class="inventory-hero">
  <div class="container hero-grid">
    <div>
      <p class="hero-kicker">Admin · Inventory</p>
      <h1>Keep your catalogue looking sharp</h1>
      <p>Review, adjust, and launch products with a couple of clicks. Every change updates the storefront instantly.</p>
      <div class="inventory-actions">
        <button class="btn btn-success btn-lg px-4" data-bs-toggle="modal" data-bs-target="#addProductModal">
          <i class="bi bi-plus-circle me-2"></i>Add Product
        </button>
        <a class="btn btn-outline-light btn-lg px-4" href="/shopping" target="_blank">View Storefront</a>
      </div>
    </div>
    <div class="inventory-stats">
      <div class="stat-card">
        <p class="stat-label">Products</p>
        <h3><%= totalProducts %></h3>
        <span>Active listings</span>
      </div>
      <div class="stat-card">
        <p class="stat-label">Categories</p>
        <h3><%= uniqueCategories.length %></h3>
        <span>Organized groups</span>
      </div>
      <div class="stat-card">
        <p class="stat-label">Avg. Price</p>
        <h3>$<%= totalProducts ? (totalValue / totalProducts).toFixed(2) : '0.00' %></h3>
        <span>Per product</span>
      </div>
    </div>
  </div>
</section>

<% const searchValue = typeof searchQuery !== 'undefined' ? searchQuery : ''; %>
<% const sortValue = typeof sortOption !== 'undefined' ? sortOption : 'newest'; %>

<section class="inventory-dashboard container">
  <div class="toast-stack">
    <% if (messages && messages.length) { %>
      <% messages.forEach(msg => { %>
        <div class="toast-message success"><i class="bi bi-check-circle"></i><span><%= msg %></span></div>
      <% }) %>
    <% } %>
    <% if (errors && errors.length) { %>
      <% errors.forEach(msg => { %>
        <div class="toast-message error"><i class="bi bi-exclamation-triangle"></i><span><%= msg %></span></div>
      <% }) %>
    <% } %>
  </div>

  <div class="dashboard-header">
    <div>
      <p class="text-muted small mb-1">Product catalogue</p>
      <h2>Manage listings</h2>
    </div>
    <form class="dashboard-filters" method="get" action="/inventory">
      <input
        type="search"
        class="form-control"
        placeholder="Quick search by name or category"
        name="search"
        value="<%= searchValue %>"
      >
      <select class="form-select" name="sort" onchange="this.form.submit()">
        <option value="newest" <%= sortValue === 'newest' ? 'selected' : '' %>>Newest first</option>
        <option value="price-asc" <%= sortValue === 'price-asc' ? 'selected' : '' %>>Price: Low to High</option>
        <option value="price-desc" <%= sortValue === 'price-desc' ? 'selected' : '' %>>Price: High to Low</option>
        <option value="name-az" <%= sortValue === 'name-az' ? 'selected' : '' %>>Name: A → Z</option>
        <option value="name-za" <%= sortValue === 'name-za' ? 'selected' : '' %>>Name: Z → A</option>
      </select>
      <button class="btn btn-success" type="submit">Search</button>
    </form>
  </div>

  <div class="inventory-grid">
    <% products.forEach(product => { %>
      <article class="inventory-card">
        <div class="card-media" style="background-image:url('/images/<%= product.image %>');"></div>
        <div class="info">
          <p class="card-category"><%= product.category %></p>
          <h5><%= product.productName %></h5>
          <p class="price">$<%= product.price.toFixed(2) %></p>
          <div class="card-meta">
            <span>ID: <%= product.id %></span>
            <span>Image: <%= product.image %></span>
          </div>
        </div>
        <div class="inventory-card-actions">
          <button class="action-btn" data-bs-toggle="modal" data-bs-target="#editModal-<%= product.id %>">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="action-btn danger" data-bs-toggle="modal" data-bs-target="#deleteModal-<%= product.id %>">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </article>

      <!-- Edit Modal -->
      <div class="modal fade" id="editModal-<%= product.id %>" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content admin-modal">
            <div class="modal-header border-0">
              <h5 class="modal-title">Edit <%= product.productName %></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form action="/inventory/edit/<%= product.id %>" method="POST" class="admin-form needs-validation" novalidate>
                <label class="form-label">Product Name</label>
                <input type="text" class="form-control mb-1" name="productName" value="<%= product.productName %>" required>
                <div class="field-error text-danger small mb-3"></div>

                <label class="form-label">Price</label>
                <input type="number" class="form-control mb-1" step="0.01" name="price" value="<%= product.price %>" required min="0">
                <div class="field-error text-danger small mb-3"></div>

                <label class="form-label">Category</label>
                <input type="text" class="form-control mb-1" name="category" value="<%= product.category %>" required>
                <div class="field-error text-danger small mb-3"></div>

                <label class="form-label">Image File Name</label>
                <input type="text" class="form-control mb-1" name="image" value="<%= product.image %>" required>
                <div class="field-error text-danger small mb-3"></div>

                <button class="btn btn-success w-100">Save Changes</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Modal -->
      <div class="modal fade" id="deleteModal-<%= product.id %>" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content admin-modal text-center">
            <div class="modal-header border-0">
              <h5 class="modal-title text-danger">Delete product?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p>You are about to remove <strong><%= product.productName %></strong> from the store catalogue.</p>
              <form action="/inventory/delete/<%= product.id %>" method="POST">
                <button class="btn btn-danger w-100 mt-2">Delete Product</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</section>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content admin-modal">
      <div class="modal-header border-0">
        <h5 class="modal-title">Add new product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/inventory/add" method="POST" class="admin-form needs-validation" novalidate>
          <label class="form-label">Product Name</label>
          <input type="text" class="form-control mb-1" name="productName" required>
          <div class="field-error text-danger small mb-3"></div>

          <label class="form-label">Price</label>
          <input type="number" class="form-control mb-1" step="0.01" name="price" required min="0">
          <div class="field-error text-danger small mb-3"></div>

          <label class="form-label">Category</label>
          <input type="text" class="form-control mb-1" name="category" required>
          <div class="field-error text-danger small mb-3"></div>

          <label class="form-label">Image File Name</label>
          <input type="text" class="form-control mb-1" name="image" required>
          <div class="field-error text-danger small mb-3"></div>

          <button class="btn btn-success w-100">Create Product</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toasts = document.querySelectorAll('.toast-message');
  toasts.forEach((toast, idx) => {
    setTimeout(() => toast.classList.add('show'), 100 * idx);
    setTimeout(() => toast.classList.remove('show'), 4000 + 200 * idx);
  });

  document.querySelectorAll('.needs-validation').forEach((form) => {
    form.addEventListener('submit', (event) => {
      let valid = true;
      form.querySelectorAll('[required]').forEach((input) => {
        const errorEl = input.nextElementSibling && input.nextElementSibling.classList.contains('field-error')
          ? input.nextElementSibling
          : null;
        if (!input.value.trim() || (input.type === 'number' && Number(input.value) < 0)) {
          valid = false;
          input.classList.add('is-invalid');
          if (errorEl) errorEl.textContent = 'Please provide a valid value.';
        } else {
          input.classList.remove('is-invalid');
          if (errorEl) errorEl.textContent = '';
        }
      });
      if (!valid) {
        event.preventDefault();
        event.stopPropagation();
      }
    });
  });

  document.querySelectorAll('.needs-validation [required]').forEach((input) => {
    input.addEventListener('input', () => {
      const errorEl = input.nextElementSibling && input.nextElementSibling.classList.contains('field-error')
        ? input.nextElementSibling
        : null;
      if (input.value.trim()) {
        input.classList.remove('is-invalid');
        if (errorEl) errorEl.textContent = '';
      }
    });
  });
});
</script>

<%- include("partials/footer") %>
