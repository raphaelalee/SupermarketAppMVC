<%- include('partials/header') %>

<section class="checkout-hero container">
  <div>
    <p class="text-muted small mb-1">Secure checkout</p>
    <h1 class="mb-1">Finish your order</h1>
    <p class="text-muted mb-0">Review your total, choose delivery, and pick how you want to pay.</p>
  </div>
  <div class="total-chip">Total: S$ <%= total.toFixed(2) %></div>
</section>

<section class="checkout-layout container">
  <div class="checkout-main">
    <form method="POST" action="/checkout" id="checkout-form" class="panel">
      <input type="hidden" name="deliveryMethod" id="deliveryMethod" value="standard">
      <input type="hidden" name="deliveryFee" id="deliveryFee" value="3.50">

      <div class="panel-group">
        <div class="panel-head">
          <h4 class="mb-1">Delivery</h4>
          <p class="text-muted small mb-0">Choose the option that works best for you.</p>
        </div>
        <div class="option-list">
          <label class="option-card">
            <input type="radio" name="delivery" value="standard" data-fee="3.50" checked>
            <div>
              <strong>Standard Delivery</strong>
              <p class="text-muted small mb-0">2-3 days · $3.50</p>
            </div>
            <span class="option-price">$3.50</span>
          </label>
          <label class="option-card">
            <input type="radio" name="delivery" value="express" data-fee="6.00">
            <div>
              <strong>Express Delivery</strong>
              <p class="text-muted small mb-0">Same day · $6.00</p>
            </div>
            <span class="option-price">$6.00</span>
          </label>
          <label class="option-card">
            <input type="radio" name="delivery" value="pickup" data-fee="0">
            <div>
              <strong>Store Pickup</strong>
              <p class="text-muted small mb-0">Collect today · Free</p>
            </div>
            <span class="option-price">$0.00</span>
          </label>
        </div>
      </div>

      <div class="panel-group">
        <div class="panel-head">
          <h4 class="mb-1">Payment method</h4>
          <p class="text-muted small mb-0">Select how you would like to pay.</p>
        </div>
        <div class="option-list payment-row">
          <label class="option-card">
            <input type="radio" name="payment" value="paynow" checked>
            <div>
              <strong>PayNow</strong>
              <p class="text-muted small mb-0">UEN: 202412345A · Instant confirmation</p>
            </div>
            <span class="pill">Recommended</span>
          </label>
          <label class="option-card">
            <input type="radio" name="payment" value="paylah">
            <div>
              <strong>PayLah! / PayAnyone</strong>
              <p class="text-muted small mb-0">Fast transfer via mobile or QR</p>
            </div>
          </label>
          <label class="option-card">
            <input type="radio" name="payment" value="card">
            <div>
              <strong>Credit / Debit Card</strong>
              <p class="text-muted small mb-0">Visa, Mastercard · Secured by SSL</p>
            </div>
          </label>
        </div>

        <div class="qr-panel" id="paynow-qr" aria-live="polite" style="display:flex;">
          <div>
            <p class="fw-semibold mb-1">Scan to pay with PayNow</p>
            <p class="small text-muted mb-2">Use your banking app to scan. Amount is S$ <%= total.toFixed(2) %>.</p>
          </div>
          <div class="qr-box">
            <img src="/images/paynow-qr.png" alt="PayNow QR code" class="qr-img">
            <p class="small text-muted mt-2 mb-0">UEN: 202412345A</p>
          </div>
        </div>

        <div class="card-fields" id="card-fields" style="display:none;">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label small text-muted">Name on card</label>
              <input type="text" class="form-control" name="cardName" placeholder="Full name">
            </div>
            <div class="col-12">
              <label class="form-label small text-muted">Card number</label>
              <input type="text" class="form-control" name="cardNumber" placeholder="1111 2222 3333 4444" maxlength="19">
            </div>
            <div class="col-6">
              <label class="form-label small text-muted">Expiry</label>
              <input type="text" class="form-control" name="cardExpiry" placeholder="MM/YY" maxlength="5">
            </div>
            <div class="col-6">
              <label class="form-label small text-muted">CVV</label>
              <input type="text" class="form-control" name="cardCvv" placeholder="123" maxlength="4">
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-success w-100 mt-3">Complete Payment</button>
      <p class="text-muted small text-center mt-2 mb-0">Transactions are encrypted. Need help? <a href="/contact">Contact us</a>.</p>
    </form>
  </div>

  <aside class="checkout-side">
    <div class="checkout-card summary">
      <h5 class="mb-3">Order summary</h5>
      <div class="mini-item-list">
        <% (items || []).forEach(it => { %>
          <div class="mini-item">
            <img src="/images/<%= it.image || 'broccoli.png' %>" alt="<%= it.productName %>">
            <div>
              <p class="mb-0"><%= it.productName %></p>
              <p class="text-muted small mb-0">Qty: <%= it.quantity %> · $<%= Number(it.price).toFixed(2) %></p>
            </div>
            <strong>$<%= Number(it.subtotal || 0).toFixed(2) %></strong>
          </div>
        <% }) %>
      </div>
      <div class="summary-row mt-2">
        <span>Subtotal</span>
        <strong id="summary-subtotal">S$ <%= total.toFixed(2) %></strong>
      </div>
      <div class="summary-row">
        <span>Delivery</span>
        <strong id="summary-delivery">S$ 3.50*</strong>
      </div>
      <p class="text-muted small mb-3">*Exact delivery fee calculated at checkout based on option selected.</p>
      <div class="summary-row total-row">
        <span>Total</span>
        <strong id="summary-total">S$ <%= (total + 3.5).toFixed(2) %></strong>
      </div>
    </div>
    <div class="checkout-card text-center">
      <img src="/images/sg-pay.png" alt="PayNow/PayLah Logos" width="180">
      <p class="small text-muted mt-2 mb-0">We accept PayNow, PayLah!, and major cards.</p>
    </div>
  </aside>
</section>

<%- include('partials/footer') %>

<script>
  (function() {
    const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
    const deliveryMethodInput = document.getElementById('deliveryMethod');
    const deliveryFeeInput = document.getElementById('deliveryFee');
    const summaryDelivery = document.getElementById('summary-delivery');
    const summaryTotal = document.getElementById('summary-total');
    const subtotal = <%= total.toFixed(2) %>;
    const cardFields = document.getElementById('card-fields');
    const paymentRadios = document.querySelectorAll('input[name="payment"]');
    const paynowQr = document.getElementById('paynow-qr');

    function formatMoney(val) {
      return 'S$ ' + Number(val).toFixed(2);
    }

    function updateDelivery() {
      const selected = Array.from(deliveryRadios).find(r => r.checked);
      const fee = selected ? Number(selected.dataset.fee || 0) : 0;
      deliveryMethodInput.value = selected ? selected.value : 'standard';
      deliveryFeeInput.value = fee.toFixed(2);
      summaryDelivery.textContent = formatMoney(fee) + '*';
      summaryTotal.textContent = formatMoney(Number(subtotal) + fee);
    }

    function togglePaymentBlocks() {
      const selected = Array.from(paymentRadios).find(r => r.checked);
      const payment = selected ? selected.value : '';
      cardFields.style.display = payment === 'card' ? 'block' : 'none';
      if (paynowQr) {
        paynowQr.style.display = payment === 'paynow' ? 'flex' : 'none';
      }
    }

    deliveryRadios.forEach(r => r.addEventListener('change', updateDelivery));
    paymentRadios.forEach(r => r.addEventListener('change', togglePaymentBlocks));
    updateDelivery();
    togglePaymentBlocks();
  })();
</script>
