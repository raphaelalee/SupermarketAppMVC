
<!--
  NOTES (Admin Orders Dashboard)
  - This dashboard composes several data sections: totals, recentOrders, sales charts, low stock alerts.
  - To add/remove cards, edit the corresponding `<div class="card">` block below. Keep Bootstrap grid classes in sync (col-*) to avoid layout shifts.
  - We removed the 'Best selling products' card earlier; to re-add it, restore the `bestSellers` block near the 'Sales by category' card.
  - If the charts show no data, they already render a friendly placeholder â€” the chart data is passed from `AdminController`.
-->

<%- include('partials/header') %>

<% const totals = (dashboard && dashboard.totals) || { products: 0, orders: 0, revenue: 0 }; %>
<% const lowStockList = (dashboard && dashboard.lowStock) || []; %>
<% const recentOrders = (dashboard && dashboard.recentOrders) || []; %>
<% const salesChart = (dashboard && dashboard.dailySales) || { labels: [], revenue: [], orders: [] }; %>
<% const meta = (dashboard && dashboard.meta) || {}; %>
<% const analytics = (dashboard && dashboard.analytics) || {}; %>
<% const bestSellers = analytics.bestSellers || []; %>
<% const categorySales = analytics.salesByCategory || []; %>
<% const hourlySales = analytics.salesByHour || { labels: [], revenue: [], orders: [] }; %>
<% const returningCustomers = analytics.returningCustomers || []; %>
<% const topCategoryRevenue = categorySales.length ? Number(categorySales[0].revenue || 1) : 1; %>

<section class="container py-4">
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
    <div>
      <p class="text-muted small mb-1 text-uppercase">Admin overview</p>
      <h1 class="h3 mb-0 fw-semibold">Orders & Fulfillment</h1>
    </div>
    <span class="text-muted small">Updated <%= new Date().toLocaleString('en-SG', { hour12: false }) %></span>
  </div>

  <% if ((errors && errors.length) || (messages && messages.length)) { %>
    <div class="mb-3">
      <% (errors || []).forEach(msg => { %>
        <div class="alert alert-danger py-2 mb-2"><%= msg %></div>
      <% }) %>
      <% (messages || []).forEach(msg => { %>
        <div class="alert alert-success py-2 mb-2"><%= msg %></div>
      <% }) %>
    </div>
  <% } %>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small text-uppercase mb-1">Total products</p>
          <h2 class="fw-semibold mb-0"><%= totals.products %></h2>
          <span class="text-muted small">Active listings</span>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small text-uppercase mb-1">Total revenue</p>
          <h2 class="fw-semibold mb-0">S$ <%= Number(totals.revenue || 0).toFixed(2) %></h2>
          <span class="text-muted small">Lifetime sales</span>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small text-uppercase mb-1">Total orders</p>
          <h2 class="fw-semibold mb-0"><%= totals.orders %></h2>
          <span class="text-muted small">Completed checkouts</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="card-title mb-1">Daily sales</h5>
              <p class="text-muted small mb-0">Last <%= meta.dailySalesDays || 7 %> days</p>
            </div>
          </div>
          <div class="chart-wrapper" style="min-height:280px;">
            <canvas id="dailySalesChart" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="card-title mb-1">Low stock alerts</h5>
              <p class="text-muted small mb-0">Below <%= meta.lowStockThreshold || 10 %> units</p>
            </div>
            <span class="badge bg-warning-subtle text-warning-emphasis">Restock</span>
          </div>
          <% if (!lowStockList.length) { %>
            <p class="text-muted small mb-0">No low stock alerts.</p>
          <% } else { %>
            <ul class="list-group list-group-flush">
              <% lowStockList.forEach(item => { %>
                <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                  <div>
                    <p class="mb-0 fw-semibold"><%= item.productName %></p>
                    <small class="text-muted">ID: <%= item.id %></small>
                  </div>
                  <span class="badge bg-danger-subtle text-danger-emphasis px-3 py-2"><%= item.quantity %> left</span>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0 mb-4" id="recent-orders">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h5 class="card-title mb-1">Recent orders</h5>
          <p class="text-muted small mb-0">Latest <%= meta.recentOrdersLimit || 5 %> checkouts</p>
        </div>
        <a href="#orders-table" class="btn btn-link btn-sm text-decoration-none">Jump to full list</a>
      </div>
      <% if (!recentOrders.length) { %>
        <p class="text-muted small mb-0">No orders yet.</p>
      <% } else { %>
        <ul class="list-group list-group-flush">
          <% recentOrders.forEach(order => { %>
            <li class="list-group-item px-0">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                  <p class="mb-0 fw-semibold"><%= order.orderNumber %> &middot; <%= order.customerName %></p>
                  <small class="text-muted"><%= order.displayDate || '-' %> &middot; <%= order.itemsCount %> items</small>
                </div>
                <div class="text-end">
                  <p class="mb-0 fw-semibold text-success">S$ <%= Number(order.total || 0).toFixed(2) %></p>
                  <small class="text-muted text-capitalize"><%= order.paymentMethod %> &middot; <%= order.status %></small>
                </div>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">Sales by category</h5>
          <% if (!categorySales.length) { %>
            <p class="text-muted small mb-0">No category breakdown yet.</p>
          <% } else { %>
            <% categorySales.forEach(cat => { %>
              <div class="mb-3">
                <div class="d-flex justify-content-between">
                  <span class="fw-semibold"><%= cat.category %></span>
                  <span class="text-muted small">S$ <%= Number(cat.revenue || 0).toFixed(2) %></span>
                </div>
                <div class="progress" style="height:6px;">
                  <div
                    class="progress-bar bg-success"
                    role="progressbar"
                    style="width:<%= Math.min(100, topCategoryRevenue ? (cat.revenue / topCategoryRevenue) * 100 : 0) %>%"
                  ></div>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="card-title mb-1">Sales by hour</h5>
              <p class="text-muted small mb-0">Last <%= 24 %> hours</p>
            </div>
          </div>
          <div class="chart-wrapper" style="min-height:260px;">
            <canvas id="hourlySalesChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">Returning customers</h5>
          <% if (!returningCustomers.length) { %>
            <p class="text-muted small mb-0">No repeat buyers yet.</p>
          <% } else { %>
            <ul class="list-group list-group-flush">
              <% returningCustomers.forEach(customer => { %>
                <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                  <div>
                    <p class="mb-0 fw-semibold"><%= customer.username %></p>
                    <small class="text-muted"><%= customer.ordersCount %> orders</small>
                  </div>
                  <span class="text-success fw-semibold">S$ <%= Number(customer.totalSpent || 0).toFixed(2) %></span>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive shadow-sm border rounded" id="orders-table">
    <div class="p-3 border-bottom bg-light">
      <h5 class="mb-0">All orders</h5>
    </div>
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th scope="col">Customer Name</th>
          <th scope="col">Order #</th>
          <th scope="col">Items</th>
          <th scope="col">Total</th>
          <th scope="col">Payment Method</th>
          <th scope="col">Status</th>
          <th scope="col">Paid</th>
          <th scope="col">Placed At</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (!orders || !orders.length) { %>
          <tr>
            <td colspan="9" class="text-center text-muted py-4">No orders yet.</td>
          </tr>
        <% } else { %>
          <% orders.forEach(o => { %>
            <tr>
              <td class="fw-semibold"><%= o.customerName %></td>
              <td><%= o.orderNumber %></td>
              <td><%= o.itemsCount %></td>
              <td>S$ <%= Number(o.total || 0).toFixed(2) %></td>
              <td class="text-capitalize"><%= o.paymentMethod %></td>
              <td>
                <span class="badge text-uppercase <%= o.status === 'completed' ? 'bg-success-subtle text-success' : (o.status === 'processing' ? 'bg-info-subtle text-info' : 'bg-secondary-subtle text-secondary') %>">
                  <%= o.status.charAt(0).toUpperCase() + o.status.slice(1) %>
                </span>
              </td>
              <td>
                <% if (o.paid) { %>
                  <span class="badge text-bg-success-subtle text-success fw-semibold">Yes</span>
                <% } else { %>
                  <span class="badge text-bg-warning-subtle text-warning fw-semibold">No</span>
                <% } %>
              </td>
              <td><%= o.displayDate || "-" %></td>
              <td>
                <div class="d-flex flex-wrap gap-2">
                  <a class="btn btn-sm btn-outline-secondary" href="/admin/orders/<%= o.id %>">View</a>
                  <a class="btn btn-sm btn-outline-primary" href="/admin/orders/<%= o.id %>/receipt" target="_blank">PDF</a>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function () {
  const salesData = <%- JSON.stringify(salesChart) %>;
  const chartTarget = document.getElementById('dailySalesChart');
  if (!chartTarget) return;

  if (!salesData.labels || !salesData.labels.length) {
    const placeholder = document.createElement('p');
    placeholder.className = 'text-muted small mb-0';
    placeholder.textContent = 'No recorded sales yet.';
    if (chartTarget.parentNode) {
      chartTarget.parentNode.replaceChild(placeholder, chartTarget);
    }
    return;
  }

  new Chart(chartTarget, {
    type: 'line',
    data: {
      labels: salesData.labels,
      datasets: [
        {
          label: 'Revenue (S$)',
          data: salesData.revenue,
          borderColor: '#198754',
          backgroundColor: 'rgba(25, 135, 84, 0.1)',
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 3,
          fill: true,
          yAxisID: 'y',
        },
        {
          label: 'Orders',
          data: salesData.orders,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 3,
          fill: false,
          borderDash: [4, 4],
          yAxisID: 'y1',
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          beginAtZero: true,
          ticks: {
            callback: function (value) {
              return 'S$ ' + Number(value).toFixed(0);
            },
          },
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          beginAtZero: true,
          grid: {
            drawOnChartArea: false,
          },
          ticks: {
            precision: 0,
          },
        },
      },
      plugins: {
        legend: {
          display: true,
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              if (context.datasetIndex === 0) {
                return 'Revenue: S$ ' + Number(context.parsed.y).toFixed(2);
              }
              return 'Orders: ' + Number(context.parsed.y);
            },
          },
        },
      },
    },
  });
})();

(function () {
  const hourlyData = <%- JSON.stringify(hourlySales) %>;
  const chartTarget = document.getElementById('hourlySalesChart');
  if (!chartTarget) return;

  if (!hourlyData.labels || !hourlyData.labels.length) {
    const placeholder = document.createElement('p');
    placeholder.className = 'text-muted small mb-0';
    placeholder.textContent = 'No hourly data yet.';
    if (chartTarget.parentNode) {
      chartTarget.parentNode.replaceChild(placeholder, chartTarget);
    }
    return;
  }

  new Chart(chartTarget, {
    type: 'line',
    data: {
      labels: hourlyData.labels,
      datasets: [
        {
          label: 'Revenue (S$)',
          data: hourlyData.revenue,
          borderColor: '#6610f2',
          backgroundColor: 'rgba(102, 16, 242, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 0,
          fill: true,
        },
        {
          label: 'Orders',
          data: hourlyData.orders,
          borderColor: '#fd7e14',
          backgroundColor: 'rgba(253, 126, 20, 0.2)',
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 0,
          fill: false,
          borderDash: [3, 3],
          yAxisID: 'y1',
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => 'S$ ' + Number(value).toFixed(0),
          },
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: { precision: 0 },
        },
      },
    },
  });
})();
</script>

<%- include('partials/footer') %>
